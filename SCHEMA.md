# Telemetry Schema Documentation

## Overview

This document describes the schema for telemetry data generated by the `trim-telemetry` package. The telemetry data is output in **NDJSON format** (Newline Delimited JSON) to files in the `.telemetry/` directory.

## Schema Version

**Current Version: `1.0.0`**

The `schema_version` field is included in every telemetry record to ensure compatibility and versioning. This allows analysis tools to handle different schema versions appropriately.

## File Structure

```
.telemetry/
├── run_20250909_143808.ndjson
├── run_20250909_144512.ndjson
└── run_20250909_145123.ndjson
```

Each file contains one JSON object per line, representing:

- **Test telemetry records** - Individual test execution data

Note: Summary data is calculated by analysis tools from individual test records.

## Record Types

### 1. Test Telemetry Record

Each test execution generates a telemetry record with the following schema:

```json
{
  "schema_version": "1.0.0",
  "run_id": "run_20250909_143808",
  "id": "test_user_creation (tests.test_user.TestUserCreation.test_user_creation)",
  "name": "test_user_creation",
  "class": "TestUserCreation",
  "module": "tests.test_user",
  "file": "tests/test_user.py",
  "status": "passed",
  "start_time": "2025-09-09T14:38:08.123456",
  "end_time": "2025-09-09T14:38:09.373456",
  "db_queries": [
    {
      "sql_signature": "SELECT * FROM USERS WHERE ID = ?",
      "total_duration_ms": 25,
      "count": 1
    },
    {
      "sql_signature": "INSERT INTO USERS (NAME, EMAIL) VALUES (?, ?)",
      "total_duration_ms": 45,
      "count": 1
    },
    {
      "sql_signature": "UPDATE USERS SET LAST_LOGIN = NOW() WHERE ID = ?",
      "total_duration_ms": 30,
      "count": 1
    },
    {
      "sql_signature": "SELECT COUNT(*) FROM POSTS WHERE USER_ID = ?",
      "total_duration_ms": 20,
      "count": 1
    },
    {
      "sql_signature": "SELECT * FROM USERS WHERE...",
      "total_duration_ms": 75,
      "count": 3
    }
  ],
  "net_urls": [
    "https://api.example.com/users",
    "https://api.example.com/posts"
  ]
}
```

## Summary Data

Summary data is calculated by analysis tools from individual test records. This approach:

- ✅ **Eliminates redundancy** - No duplicate data in telemetry files
- ✅ **Ensures accuracy** - Summary is always calculated from actual test results
- ✅ **Supports multi-file runs** - Works correctly even if tests are split across files
- ✅ **Provides flexibility** - Analysis tools can calculate summaries however they need

### Summary Calculation

Summary data is calculated by analysis tools from individual test records. The following fields should be calculated:

- **total_tests**: Count of all test records
- **passed_tests**: Count of records with `status: "passed"`
- **failed_tests**: Count of records with `status: "failed"` or `status: "error"`
- **skipped_tests**: Count of records with `status: "skipped"`
- **exit_code**: 0 if no failed tests, 1 if any tests failed
- **total_duration**: Sum of all test durations (calculated from `start_time` and `end_time`)
- **avg_duration**: `total_duration / total_tests`

## Field Descriptions

### Common Fields

| Field | Type | Description |
|-------|------|-------------|
| `schema_version` | string | Schema version (e.g., "1.0.0") |
| `run_id` | string | Unique identifier for the test run |

### Test Telemetry Fields

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Full test identifier (class.method format) |
| `name` | string | Test method name |
| `class` | string | Test class name |
| `module` | string | Python module name |
| `file` | string | File path (relative to project root) |
| `status` | string | Test result: "passed", "failed", "error", "skipped" |
| `start_time` | string | Test start time (ISO 8601 format) |
| `end_time` | string | Test end time (ISO 8601 format) |

### Database Fields (db_ prefix)

| Field | Type | Description |
|-------|------|-------------|
| `db_queries` | array | Array of query objects with SQL, duration, and count |

### Network Fields (net_ prefix)

| Field | Type | Description |
|-------|------|-------------|
| `net_urls` | array | List of URLs that were called |

### Calculated Summary Fields

These fields are calculated by analysis tools from individual test records:

| Field | Type | Description |
|-------|------|-------------|
| `total_tests` | integer | Total number of tests executed |
| `passed_tests` | integer | Number of tests that passed |
| `failed_tests` | integer | Number of tests that failed |
| `skipped_tests` | integer | Number of tests that were skipped |
| `exit_code` | integer | Exit code (0 for success, 1 for failure) |
| `total_duration` | integer | Sum of all test durations |
| `avg_duration` | integer | Average test duration |

## Data Types

### Query Object

```json
{
  "sql_signature": "SELECT * FROM USERS WHERE ID = ?",
  "total_duration_ms": 25,
  "count": 1
}
```

**Query Object Fields:**
- `sql_signature`: The normalized SQL query signature (parameter values replaced with ?)
- `total_duration_ms`: Total duration for all executions of this query in milliseconds
- `count`: Number of times this query was executed

## Processing Guidelines

### Schema Version Handling

Always check the `schema_version` field before processing records:

- **Current version**: `1.0.0`
- **Unknown versions**: Log a warning and skip processing
- **Future versions**: Update your analysis tool to handle new schema versions

### Record Processing

- **Line-by-line processing**: Each line contains one complete JSON object
- **Error handling**: Skip malformed lines and continue processing
- **Memory efficiency**: Process records individually rather than loading entire files
- **Run correlation**: Use `run_id` to group related test records

## Schema Changelog

### Version 1.0.0 (Current)

**Release Date**: 2025-01-10

**Features**:
- Initial flattened schema design
- All fields use consistent prefixes (`db_`, `net_`)
- NDJSON format with schema versioning
- Comprehensive database query monitoring
- Network call detection
- Per-test telemetry isolation

**Field Structure**:
- `schema_version`: "1.0.0"
- `run_id`: Unique test run identifier
- `start_time`/`end_time`: Test execution timestamps for duration calculation
- `db_*`: Database-related fields (queries with durations and counts)
- `net_*`: Network-related fields (URLs)
- Test metadata: `id`, `name`, `class`, `module`, `file`, `status`

### Schema Versioning Policy

**Version Format**: `MAJOR.MINOR.PATCH`

- **MAJOR**: Breaking changes (incompatible schema changes)
- **MINOR**: New fields added (backward compatible)
- **PATCH**: Bug fixes, documentation updates

**Breaking Changes**:
- Removing fields
- Changing field types
- Changing field names
- Changing required vs optional status

**Non-Breaking Changes**:
- Adding new optional fields
- Adding new record types
- Extending enum values
- Documentation updates

### Migration Guidelines

**For Analysis Tools**:
1. Always check `schema_version` before processing
2. Handle unknown versions gracefully (log warning, skip)
3. Support multiple schema versions when possible
4. Update tools when new versions are released

**For Schema Changes**:
1. Increment version number appropriately
2. Document all changes in this changelog
3. Provide migration guide for breaking changes
4. Maintain backward compatibility when possible

## Best Practices

1. **Always check `schema_version`** before processing records
2. **Handle missing fields gracefully** - use default values
3. **Process records line-by-line** for memory efficiency
4. **Use the `run_id`** to correlate all telemetry from a single test run
5. **Validate field types** before processing to avoid runtime errors
6. **Handle malformed JSON** gracefully by skipping invalid lines

## File Naming Convention

Telemetry files are named using the pattern: `{run_id}.ndjson`

Where `run_id` follows the format: `run_{YYYYMMDD}_{HHMMSS}`

Example: `run_20250909_143808.ndjson`

This naming convention allows for:
- Chronological sorting
- Easy identification of test runs
- No file conflicts between runs
